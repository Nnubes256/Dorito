var Dorito=function(){this.logHistory=[],this.isNW=!1,this.nw=null,this.Signal=signals.Signal,this.modPath="addons/",this.initDone=!1,this.Filesystem=null};Dorito.prototype.Events={DoritoInitialized:new signals.Signal,GameLoaded:new signals.Signal,CrossCodeLoaded:new signals.Signal},Dorito.prototype._log=console.log.bind(this),Dorito.prototype._warn=console.warn.bind(this),Dorito.prototype._error=console.error.bind(this),Dorito.prototype._loadModules=function(){this.Filesystem=require("fs")},Dorito.prototype._loadNW=function(){try{return this.nw=require("nw.gui"),console.log("NW.js context detected. Dorito will load mods from dataPath."),this.isNW=!0,this._loadModules(),!0}catch(t){return console.log("Possible browser context detected. Dorito will load from addons/"),this.isNW=!1,!1}},Dorito.prototype.appendScript=function(t){return new Promise(function(n,e){try{var o=document.getElementsByTagName("head")[0],r=document.createElement("script");r.type="text/javascript",r.src=t,o.appendChild(r),n()}catch(i){e(i)}})},Dorito.prototype.createNWFolder=function(){var t=this;return new Promise(function(n,e){t.Filesystem.mkdir(t.modPath,function(t){return t?(console.error(t),e(t)):void n()})})},Dorito.prototype.loadAllNW=function(){var t=this;return new Promise(function(n,e){try{t.Filesystem.readdir(t.modPath,function(t,o){if(t)return e(t);var r=o.filter(function(t){return".js"===t.substr(-3)});console.log(r),n(r)})}catch(o){e(o)}}).then(function(n){return Promise.all(n.map(function(n){return t.appendScript(t.modPath+n)}))})["catch"](function(n){t.disable(n)})},Dorito.prototype.requestFile=function(t){return new Promise(function(n,e){var o=new XMLHttpRequest;o.open("GET",t,!0),o.onload=function(){this.status>=200&&this.status<400?n(this.response):e(new Error(this.statusText))},o.onerror=function(){e(new Error("Network error."))},o.send()})},Dorito.prototype.loadAllBrowser=function(){var t,n=this;return n.requestFile(n.modPath+"/addons.json").then(JSON.parse).then(function(e){return t=e,console.log("Found "+t.libs.length+" libs."),Promise.all(t.libs.map(function(t){return n.appendScript(n.modPath+t.path)}))}).then(function(){if(!t)throw new Error("No addons list received!");return console.log("Found "+t.addons.length+" addons."),Promise.all(t.addons.map(function(t){return n.appendScript(n.modPath+t.path)}))})["catch"](function(t){n.disable(t)})},Dorito.prototype.ready=function(){this.initDone?(console.log("Game Ready"),this.Events.GameLoaded.dispatch(),this.Events.CrossCodeLoaded.dispatch()):console.error("WARN: Didn't load in time!")},Dorito.prototype.doneInit=function(){console.log("Done init."),this.initDone=!0},Dorito.prototype.callDone=function(){this.Events.DoritoInitialized.dispatch()},Dorito.prototype.disable=function(t){throw t},Dorito.prototype.init=function(){var t=this;this._loadNW(),this.isNW?(this.modPath=this.nw.App.dataPath+"/addons/",this.loadAllNW().then(function(){return t.doneInit()})["catch"](function(n){n&&n.code&&"ENOENT"===n.code?(console.warn("Mod folder not found, creating"),t.createNWFolder().then(function(){return alert("Mod folder created at:\n\n"+self.modPath+"\n\nPlease restart the game!"),t.nw.App.quit()})["catch"](console.error.bind(this))):console.error(n)})):this.loadAllBrowser().then(function(){return t.doneInit()})["catch"](console.error.bind(this))};var dorito=new Dorito,DoritoAPI=function(t){if(!(t&&t instanceof Dorito))throw new TypeError("DoritoAPI: Dorito instance not passed as argument to init");this.dorito=t,this.self=this,this.Injectors={},this.Injectors.override=function(t,n,e){t[n]=e(t[n])},this.InjectTypes={},this.InjectTypes.after=function(t){return function(n){return function(){var e=n.apply(this,arguments);return t.apply(this,arguments),e}}},this.InjectTypes.before=function(t){return function(n){return function(){return t.apply(this,arguments),n.apply(this,arguments)}}},this.InjectTypes.filter=function(t){return function(n){return function(){var e=t.apply(this,arguments);return n.apply(this,e&&e instanceof Array?e:arguments)}}},this.InjectTypes.compose=function(t){return function(n){return function(){return t.call(this,n.apply(this,arguments))}}},this.InjectTypes.benchmark=function(t){return function(n){return function(){var e=performance.now(),o=n.apply(this,arguments),r=performance.now();return t({benchmark:e-r,returnValue:o}),o}}},this.InjectTypes.memoize=function(t){var n={};return function(){for(var e in n)if(n.hasOwnProperty(e)&&arguments==e[0])return e[1];var o=t.call(this,x);return n.push([arguments,o]),o}},this.InjectTypes.dispatch_before=function(t){function n(t){return"[object Arguments]"===Object.prototype.toString.call(t)}if(!t)throw new TypeError("No listener passed!");if(!(t instanceof signals.Signal))throw new TypeError("Listener is not a Signal!");var e=self;return function(o){var r=t;return function(){var t={};if(t.args=arguments,t.self=this,t.cancelled=!1,r.dispatch(t),t.cancelled)return null;var i=t.args||arguments;return i instanceof Array||n(i)||(e.dorito._warn("dispatch_before result is not an array, using original arguments. NOTE new versions shouldn't let code reach here!"),i=arguments),o.apply(this,i)}}},this.InjectTypes.dispatch_after=function(t){if(!t)throw new TypeError("No listener passed!");if(!(t instanceof signals.Signal))throw new TypeError("Listener is not a Signal!");self;return function(n){var e=t;return function(){var t={};t.args=arguments,t.self=this;var o=n.apply(this,arguments);t.args!=arguments?t._argsAfterRun=arguments:t._argsAfterRun=null,t.returnValue=o,e.dispatch(t)}}},this.GameCanvas={},this.GameCanvas.canvas=document.getElementById("canvas"),this.GameCanvas.getCanvas=function(){return this.GameCanvas.canvas},this.GameCanvas.getContext=function(){return this.GameCanvas.canvas.getContext("2d")},console.log("DoritoAPI loaded")},dorito_api=new DoritoAPI(dorito);